# 小节时值检测功能测试用例

## 功能说明

本功能用于检测 ABC 乐谱中每个小节的时值是否与头部定义的拍号（Meter）匹配。

### 检测规则

- **正常 (ok)**: 小节时值等于拍号定义的时值
- **超限 (overflow)**: 小节时值超过拍号定义的时值（红色标记）
- **不足 (underflow)**: 小节时值小于拍号定义的时值（黄色标记）

### 时值计算

| 拍号 | 每小节期望时值 |
|------|----------------|
| 4/4  | 1.0 (全音符)   |
| 3/4  | 0.75           |
| 2/4  | 0.5            |
| 6/8  | 0.75           |
| 2/2  | 1.0            |

---

## 测试用例

### 1. 正常情况 - 4/4 拍完整小节

```abc
X:1
T:Test Case 1 - Normal 4/4
M:4/4
L:1/4
K:C
C D E F | G A B c | c B A G | F E D C |
```

**期望结果**: 所有小节显示正常，无警告标记

---

### 2. 超限情况 - 4/4 拍小节时值过多

```abc
X:1
T:Test Case 2 - Overflow 4/4
M:4/4
L:1/4
K:C
C D E F G | A B c d | c B A G | F E D C |
```

**期望结果**: 第1、2小节显示红色背景和"⚠超"标记（5个四分音符超过4拍）

---

### 3. 不足情况 - 4/4 拍小节时值不足

```abc
X:1
T:Test Case 3 - Underflow 4/4
M:4/4
L:1/4
K:C
C D E | G A B c | c B A | F E D C |
```

**期望结果**: 第1、3小节显示黄色背景和"⚠缺"标记（3个四分音符不足4拍）

---

### 4. 混合情况 - 同时存在超限和不足

```abc
X:1
T:Test Case 4 - Mixed Issues
M:4/4
L:1/4
K:C
C D E F G | A B c | c B A G | F E |
```

**期望结果**: 
- 第1小节: 红色背景 "⚠超"（5拍）
- 第2小节: 黄色背景 "⚠缺"（3拍）
- 第3小节: 正常（4拍）
- 第4小节: 黄色背景 "⚠缺"（2拍）

---

### 5. 3/4 拍测试

```abc
X:1
T:Test Case 5 - 3/4 Time
M:3/4
L:1/4
K:C
C D E | F G A | B c d | e d c |
C D E F | G A | B c d | e d c |
```

**期望结果**:
- 第1-4小节: 正常（3拍）
- 第5小节: 红色背景 "⚠超"（4拍）
- 第6小节: 黄色背景 "⚠缺"（2拍）
- 第7-8小节: 正常（3拍）

---

### 6. 2/4 拍测试

```abc
X:1
T:Test Case 6 - 2/4 Time
M:2/4
L:1/8
K:C
CD EF | GA Bc | cB AG | FE DC |
CDE F | GA | cB AG | FE DC |
```

**期望结果**:
- 第1-4小节: 正常（每小节4个八分音符=2拍）
- 第5小节: 红色背景 "⚠超"（5个八分音符）
- 第6小节: 黄色背景 "⚠缺"（2个八分音符=1拍）

---

### 7. 6/8 拍测试

```abc
X:1
T:Test Case 7 - 6/8 Time
M:6/8
L:1/8
K:C
CDE FGA | Bcd efg | abc' b'a'g' | f'e'd' c'BA |
CDEFGA B | cde | abc' b'a'g' | f'e'd' c'BA |
```

**期望结果**:
- 第1-4小节: 正常（6个八分音符）
- 第5小节: 红色背景 "⚠超"（7个八分音符）
- 第6小节: 黄色背景 "⚠缺"（3个八分音符）

---

### 8. 包含休止符的测试

```abc
X:1
T:Test Case 8 - With Rests
M:4/4
L:1/4
K:C
C D z F | z z z z | C D E | G A B c z |
```

**期望结果**:
- 第1小节: 正常（4拍，含1个休止符）
- 第2小节: 正常（4拍，全休止符）
- 第3小节: 黄色背景 "⚠缺"（3拍）
- 第4小节: 红色背景 "⚠超"（5拍）

---

### 9. 包含长音符的测试

```abc
X:1
T:Test Case 9 - Long Notes
M:4/4
L:1/4
K:C
C4 | D2 E2 | F G A B | c2 d e |
C4 D | E2 F | G A B c d | e2 |
```

**期望结果**:
- 第1小节: 正常（1个全音符=4拍）
- 第2小节: 正常（2个二分音符=4拍）
- 第3小节: 正常（4个四分音符=4拍）
- 第4小节: 正常（二分音符+2个四分音符=4拍）
- 第5小节: 红色背景 "⚠超"（全音符+四分音符=5拍）
- 第6小节: 黄色背景 "⚠缺"（二分音符+四分音符=3拍）
- 第7小节: 红色背景 "⚠超"（5个四分音符=5拍）
- 第8小节: 黄色背景 "⚠缺"（二分音符=2拍）

---

### 10. 包含附点音符的测试

```abc
X:1
T:Test Case 10 - Dotted Notes
M:4/4
L:1/4
K:C
C3/2 D/2 E F | G3/2 A/2 B3/2 c/2 | C3/2 D/2 E | G3/2 A/2 B c d |
```

**期望结果**:
- 第1小节: 正常（附点四分+八分+四分+四分=4拍）
- 第2小节: 正常（2组附点四分+八分=4拍）
- 第3小节: 黄色背景 "⚠缺"（3拍）
- 第4小节: 红色背景 "⚠超"（5拍）

---

### 11. 弱起小节测试

```abc
X:1
T:Test Case 11 - Anacrusis (Pickup Measure)
M:4/4
L:1/4
K:C
G | C D E F | G A B c | c B A G | F E D C |
```

**期望结果**:
- 第1小节（弱起）: 黄色背景 "⚠缺"（1拍，这是预期行为，弱起小节通常不完整）
- 第2-5小节: 正常（4拍）

---

### 12. 复杂节奏测试

```abc
X:1
T:Test Case 12 - Complex Rhythms
M:4/4
L:1/8
K:C
C2 DE FG A2 | B2 c2 d2 e2 | CD EF GA Bc | de fg ab c'd' e'f' |
```

**期望结果**:
- 第1小节: 正常（四分+2八分+2八分+四分=4拍）
- 第2小节: 正常（4个四分音符=4拍）
- 第3小节: 正常（8个八分音符=4拍）
- 第4小节: 红色背景 "⚠超"（16个八分音符=8拍）

---

## 边界情况

### 13. 空小节

```abc
X:1
T:Test Case 13 - Empty-like Measure
M:4/4
L:1/4
K:C
C D E F || G A B c |
```

**期望结果**: 检测双小节线前后的小节是否正确处理

---

### 14. 极小时值差异

```abc
X:1
T:Test Case 14 - Tiny Duration Difference
M:4/4
L:1/4
K:C
C D E F | G A B c |
```

**期望结果**: 浮点数计算误差不应触发错误警告

---

## 使用方法

1. 在编辑器中输入上述 ABC 代码
2. 切换到"简谱"视图
3. 启用 Debug Mode（如果可用）查看详细信息
4. 观察每个小节的背景颜色和警告标记

## 颜色说明

| 颜色 | 含义 |
|------|------|
| 无背景 | 时值正常 |
| 淡红色背景 + "⚠超" | 时值超限 |
| 淡黄色背景 + "⚠缺" | 时值不足 |
