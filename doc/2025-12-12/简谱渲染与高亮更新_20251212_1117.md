# 简谱渲染与播放高亮功能更新文档

## 更新概览

本次更新（2025-12-12 11:15）主要重构了简谱的渲染方式，并实现了播放与视觉的高亮同步。

### 核心变更

1.  **架构分离**：
    *   **架构变更**：从原有的“在五线谱上加歌词”方案，切换为“双引擎”方案。
    *   **音频引擎**：保留 `abcjs` 用于生成音频流、MIDI 事件和时值计算。
    *   **视觉引擎**：新建 Vue 组件 `JianpuScore.vue`，独立负责简谱的绘制。

2.  **简谱视图渲染器 (`JianpuScore.vue`)**：
    *   实现了基于 HTML/CSS 的简谱渲染。
    *   支持根据调号（Key）自动计算音级（1-7）。
    *   支持使用 Unicode 组合字符渲染高音点（上点）和低音点（下点）。
    *   支持根据时值自动渲染下划线（减时线）和延音线（增时线）。
    *   支持小节线、休止符（0）的显示。

3.  **编辑器交互更新 (`Editor.vue`)**：
    *   **视图切换**：新增“五线谱 / 简谱”切换按钮。
    *   **无缝播放**：切换视图不中断音频播放逻辑。简谱模式下，五线谱在后台保持活跃以驱动音频。
    *   **高亮同步**：
        *   通过在 `abcjs` 生成的对象中注入 `_myId`，建立音符数据与 DOM 的映射。
        *   播放时，捕捉 `abcjs` 事件，通过映射关系实时高亮简谱中对应的数字。

## 文件变更列表

*   `src/components/JianpuScore.vue`: [新增] 自定义简谱渲染组件。
*   `src/views/Editor.vue`: [修改] 集成 JianpuScore，添加视图切换逻辑，移除旧版生成逻辑。
*   `src/utils/jianpu.js`: [废弃] 旧版文本生成工具不再使用（逻辑已迁移至组件内部）。

## 验证方法 (Verification)

1.  **打开乐谱**：进入编辑页面。
2.  **切换视图**：点击右上角“简谱”按钮，界面应变为数字简谱显示。
3.  **检查渲染**：确认音符数字、高低音点、下划线显示正确。
4.  **播放测试**：点击播放按钮。
    *   **听**：音乐正常播放。
    *   **看**：随着音乐进行，简谱上的数字（或下划线/延音线）应实时变红高亮。

## 后续优化方向

*   **装饰音支持**：目前简谱渲染暂忽略复杂的装饰音，后续需补充。
*   **连音线支持**：尚未实现连音弧线的绘制。
*   **打印支持**：需优化 CSS 以支持高质量的简谱打印。
