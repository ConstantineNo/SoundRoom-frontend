# 音频控制销毁与三连音渲染安全性调整说明

- **关联提交**: `fbe129b`（fix: improve audio cleanup, triplet safety and update README rules）
- **修改日期**: 2025-12-16

## 一、README 提交规范补充

- 在根目录 `README.md` 中新增了 Git 提交规范章节：
  - 要求使用中文撰写提交信息。
  - 约定 `feat / fix / docs / style / refactor / perf / test / chore` 等标准 type。
  - 说明 Header 长度与 Body、Footer 的基本格式。
  - 要求更详细的说明文档以 Markdown 形式存放到 `doc/YYYY-MM-DD` 目录下，并遵守命名规范 `文档名称_YYYYMMDD_HHMM.md`。

## 二、Editor.vue：音频控制器生命周期管理

### 1. 问题背景

- 之前在离开编辑器路由时，仅将 `synthControl` 置为 `null`，没有显式调用 `disable(true)`：
  - 可能导致音频在页面销毁后继续播放。
  - 可能残留事件监听与 `AudioContext`，造成内存泄漏或控制台报错。

### 2. 调整内容

- 在 `onUnmounted` 钩子中：
  - 调用 `synthControl.disable(true)`，确保：
    - 停止播放。
    - 解绑事件监听。
  - 使用 `try/catch` 捕获可能的 DOM/Audio 状态异常，防止路由切换过程中抛出未捕获错误。
  - 清理与自适应布局相关的 `ResizeObserver`：
    - `resizeObserver.disconnect()` 后将其置为 `null`。
  - 清理和播放跳转相关的映射：
    - `elemToIdMap.clear()`
    - `noteIdToTimingMap.clear()`

### 3. 影响范围

- 仅影响编辑器页面路由切换与销毁时的资源释放行为。
- 对现有播放功能无行为变化，只是更彻底地清理资源。

## 三、JianpuScore.vue：三连音渲染安全性

### 1. 问题背景

- 在 `generateTriplets(measure)` 函数中，原逻辑为：
  - 遇到 `note.startTriplet` 时记录 `currentGroup.startNote`。
  - 遇到 `note.endTriplet` 时记录 `currentGroup.endNote`，并直接使用：
    - `s.x + 5` 与 `e.x + (e.displayWidth > 20 ? 25 : e.displayWidth - 5)` 绘制三连音标记。
- 风险点：
  - ABCJS 在某些情况下可能出现：
    - `startTriplet` 与 `endTriplet` 标记在同一音符上。
    - 存在嵌套三连音或格式错误的 ABC 片段。
  - 这些情况会导致 `currentGroup` 状态异常，最终 `s` 或 `e` 为空或缺少合法的 `x` 坐标，从而在渲染阶段抛出错误。

### 2. 调整内容

- 在计算三连音绘制区间之前增加安全检查：
  - 确保 `s` 与 `e` 均存在：
    - `if (s && e && typeof s.x === 'number' && typeof e.x === 'number') { ... }`
  - 仅在数据完整且坐标有效时向 `measure.tripletGroups` 推入绘制信息。
  - 如果数据异常：
    - 输出警告日志：`[JianpuScore] 三连音组数据不完整，跳过渲染`。
    - 跳过该三连音组的绘制，避免整条谱渲染失败。

### 3. 影响范围

- 三连音标记的绘制更稳健：
  - 对于正常的 ABC 数据，行为与之前保持一致。
  - 对于异常或边缘情况（嵌套、缺失标记、解析异常），不再因三连音单点出错而影响整行或整首谱的渲染。

## 四、后续建议

- 对涉及 abcjs 原始结构的解析逻辑（如连音线、圆滑线、分段标记等）统一增加防御式编程：
  - 所有跨元素/跨小节的关系，在解构前都先做空值与类型校验。
- 在调试环境（`debugMode=true`）下，保留详细的 `console.warn` 输出，便于排查特例谱面。
