# 竹笛智能练习平台 - API 接口文档

**基础 URL:** `http://localhost:8000` (开发环境默认地址)

## 1. 认证模块 (`/auth`)

### 注册用户
创建新用户账户。

*   **URL:** `/auth/register`
*   **方法:** `POST`
*   **Content-Type:** `application/json`
*   **请求体:**
    ```json
    {
      "username": "user1",
      "password": "password123"
    }
    ```
*   **成功响应 (200 OK):**
    ```json
    {
      "username": "user1",
      "id": 1,
      "role": "user"
    }
    ```
*   **错误响应:**
    *   **Code:** 400 Bad Request
    *   **Content:** `{"detail": "Username already registered"}`

### 用户登录
用户登录并获取访问令牌（Token）。

*   **URL:** `/auth/login`
*   **方法:** `POST`
*   **Content-Type:** `application/x-www-form-urlencoded`
*   **请求体:**
    *   `username`: "user1"
    *   `password`: "password123"
*   **成功响应 (200 OK):**
    ```json
    {
      "access_token": "eyJhbGciOiJIUzI1NiIsIn...",
      "token_type": "bearer"
    }
    ```
*   **错误响应:**
    *   **Code:** 401 Unauthorized
    *   **Content:** `{"detail": "Incorrect username or password"}`

---

## 2. 曲谱管理 (`/scores`)

### 创建曲谱
上传包含图片和音频的新曲谱。

*   **URL:** `/scores/`
*   **方法:** `POST`
*   **Content-Type:** `multipart/form-data`
*   **请求参数 (Form Data):**
    *   `title` (string): 曲谱标题
    *   `song_key` (string): 歌曲调号 (如 "G")
    *   `flute_key` (string): 笛子调号 (如 "C")
    *   `fingering` (string): 指法类型 (如 "3")
    *   `tags` (string, optional): 标签，逗号分隔 (如 "流行,初级")
    *   `image` (file): 曲谱图片文件
    *   `audio` (file): 伴奏音频文件
*   **成功响应 (200 OK):**
    ```json
    {
      "title": "茉莉花",
      "song_key": "G",
      "flute_key": "C",
      "fingering": "3",
      "tags": ["民歌"],
      "id": 1,
      "image_path": "uploads/img_filename.jpg",
      "image_path": "uploads/img_filename.jpg",
      "audio_path": "uploads/audio_filename.mp3",
      "abc_source": null,
      "structured_data": null
    }
    ```

### 获取曲谱列表
获取系统中所有可用的曲谱。

*   **URL:** `/scores/`
*   **方法:** `GET`
*   **查询参数:**
    *   `skip` (int, 默认 0): 跳过的数量
    *   `limit` (int, 默认 100): 返回的数量限制
*   **成功响应 (200 OK):**
    *   返回一个包含上述曲谱对象的数组。

### 获取曲谱详情
根据ID获取单个曲谱的详细信息。

*   **URL:** `/scores/{score_id}`
*   **方法:** `GET`
*   **路径参数:**
    *   `score_id`: 曲谱ID
*   **成功响应 (200 OK):**
    *   返回单个曲谱对象。
*   **错误响应:**
    *   **Code:** 404 Not Found
    *   **Content:** `{"detail": "Score not found"}`

### 更新曲谱乐谱代码 (ABC)
上传或更新曲谱的 ABC 源码，并触发服务器端解析生成结构化数据。

*   **URL:** `/scores/{score_id}/abc`
*   **方法:** `PUT`
*   **Content-Type:** `application/json`
*   **路径参数:**
    *   `score_id`: 曲谱ID
*   **请求体:**
    ```json
    {
      "abc_content": "X:1\nT:Test Song\nK:C\nM:4/4\nL:1/4\n| C D E F |"
    }
    ```
*   **成功响应 (200 OK):**
    ```json
    {
      "id": 1,
      "title": "茉莉花",
      "abc_source": "X:1...",
      "structured_data": {
        "meta": { "title": "Test Song", "key": "C major", "meter": "4/4", "tempo": 120 },
        "measures": [ ... ]
      },
      ...
    }
    ```
*   **错误响应:**
    *   **Code:** 400 Bad Request (解析失败)
    *   **Content:** `{"detail": "Failed to parse ABC content..."}`
    *   **Code:** 404 Not Found (曲谱不存在)

---

## 3. 播放列表 (`/playlists`)
*需要 Authentication Header: `Authorization: Bearer <token>`*

### 创建播放列表
为当前用户创建一个新的播放列表。

*   **URL:** `/playlists/`
*   **方法:** `POST`
*   **Content-Type:** `application/json`
*   **请求体:**
    ```json
    {
      "name": "我的练习清单"
    }
    ```
*   **成功响应 (200 OK):**
    ```json
    {
      "name": "我的练习清单",
      "id": 1,
      "user_id": 1,
      "items": []
    }
    ```

### 获取我的播放列表
获取当前用户的所有播放列表。

*   **URL:** `/playlists/`
*   **方法:** `GET`
*   **成功响应 (200 OK):**
    *   返回播放列表对象的数组。

### 添加曲谱到播放列表
将指定曲谱添加到播放列表中。

*   **URL:** `/playlists/{playlist_id}/items`
*   **方法:** `POST`
*   **路径参数:**
    *   `playlist_id`: 播放列表ID
*   **查询参数:**
    *   `score_id`: 要添加的曲谱ID
*   **成功响应 (200 OK):**
    ```json
    {
      "score_id": 5,
      "sort_order": 0,
      "id": 10,
      "playlist_id": 1,
      "score": { ...Score Object... }
    }
    ```
*   **错误响应:**
    *   **Code:** 404 Not Found
    *   **Content:** `{"detail": "Playlist not found"}` 或 `{"detail": "Score not found"}`

---

## 4. 录音管理 (`/recordings`)
*需要 Authentication Header: `Authorization: Bearer <token>`*

### 上传录音
上传用户针对某一曲谱的练习录音。

*   **URL:** `/recordings/`
*   **方法:** `POST`
*   **Content-Type:** `multipart/form-data`
*   **请求参数 (Form Data):**
    *   `score_id` (int): 关联的曲谱ID
    *   `file` (file): 录音音频文件
*   **成功响应 (200 OK):**
    ```json
    {
      "score_id": 1,
      "id": 15,
      "user_id": 1,
      "file_path": "uploads/rec_1_1_filename.mp3"
    }
    ```

### 获取我的录音
获取当前用户的所有录音历史。

*   **URL:** `/recordings/`
*   **方法:** `GET`
*   **成功响应 (200 OK):**
    *   返回录音对象的数组。

---

## 5. 调试工具 (`/debug`)

### 上传调试日志
客户端可以将音频处理相关的调试信息发送到服务器。

*   **URL:** `/debug/log`
*   **方法:** `POST`
*   **Content-Type:** `application/json`
*   **请求体:**
    ```json
    {
      "timestamp": 1638200000.0,
      "userAgent": "Mozilla/5.0...",
      "audioContext": {
        "sampleRate": 44100,
        "state": "running",
        "baseLatency": 0.01,
        "outputLatency": 0.02
      },
      "pitchInfo": {
        "rms": 0.05,
        "rawFreq": 440.0,
        "probability": 0.9,
        "detectedFreq": 440.0,
        "processingTimeMs": 15.0
      },
      "message": "可选的日志消息"
    }
    ```
*   **成功响应 (200 OK):**
    *   **Code:** 200 OK
    *   **Content:** `{"status": "ok", "saved_to": "debug_logs.jsonl"}`
