# 卡拉OK简谱模式实现文档

## 1. 概述

本次更新为练功房（Workbench）模块新增了一个**卡拉OK风格简谱显示模式**，提供类似卡拉OK演唱时的滚动显示体验，帮助用户更专注于当前正在演奏的小节，提升练习效率。

### 1.1 核心特性

- ✨ 双行显示：同时显示"正在播放"和"等待播放"两行简谱
- 🎯 智能切换：播放完成后自动切换到下一组小节
- 🎨 实时高亮：当前播放音符实时高亮显示
- ⚙️ 灵活配置：可调节每行显示的小节数（1-8，默认2）
- 📱 响应式设计：适配移动端和桌面端
- 🌙 简约美观：深色渐变背景，优雅的动画效果

---

## 2. 技术实现

### 2.1 新增文件

#### KaraokeRenderer.vue
**路径**: `src/components/Score/KaraokeRenderer.vue`

**职责**: 
- 卡拉OK模式的核心渲染组件
- 接收 ABC 解析后的 `visualObj` 并转换为简谱
- 管理双行显示逻辑和自动切换
- 处理音符高亮同步

**主要 Props**:
```typescript
{
  tune: Object,           // abcjs 解析的 visualObj
  activeNoteIds: Array,   // 当前激活的音符 ID 列表
  targetKey: String,      // 目标调性（如 "G", "D" 等）
  playbackTime: Number    // 当前播放时间（秒）
}
```

**核心功能模块**:

1. **小节解析模块** (`allMeasures` computed)
   - 遍历 `tune.lines` 解析所有小节
   - 将音高转换为简谱数字（1-7）
   - 计算音符的时值信息（减时线、延音线、附点等）
   - 为每个音符分配唯一 ID

2. **双行布局模块** (`currentLineMeasures` / `nextLineMeasures`)
   - 根据 `measuresPerLine` 计算每行显示的小节
   - 动态计算小节和音符的 SVG 坐标
   - 处理响应式布局调整

3. **自动切换模块** (watch `activeNoteIds`)
   - 监听当前播放的音符 ID
   - 查找音符所在的小节
   - 计算目标行索引并触发切换动画

4. **交互控制模块**
   - 增减小节数按钮
   - 进度显示（当前小节 / 总小节）
   - 响应式容器监听

### 2.2 修改文件

#### Workbench.vue
**路径**: `src/views/Workbench.vue`

**修改内容**:

1. **导入 KaraokeRenderer 组件**
```javascript
import KaraokeRenderer from '../components/Score/KaraokeRenderer.vue'
```

2. **视图模式扩展**
   - 在 `viewMode` 选项中增加 `'karaoke'`
   - 在工具栏添加"🎤 卡拉OK"按钮

3. **条件渲染**
```vue
<div v-if="viewMode === 'karaoke'" class="stage-content karaoke-mode">
  <div class="stage-inner karaoke-inner">
    <KaraokeRenderer
      v-if="visualObj && score"
      :tune="visualObj"
      :active-note-ids="abcActiveNoteIds"
      :target-key="score.song_key"
      :playback-time="playbackTime"
      @seek-to-note="onJianpuSeek"
    />
    <div v-else class="loading-text">暂无 ABC 乐谱，无法显示卡拉OK模式</div>
  </div>
</div>
```

4. **MIDI 模式判断更新**
```javascript
const isMidiMode = computed(() => 
  viewMode.value === 'jianpu' || 
  viewMode.value === 'staff' || 
  viewMode.value === 'karaoke'
)
```

5. **乐器选择器显示逻辑**
   - 将卡拉OK模式纳入需要显示乐器选择器的视图

6. **样式新增**
```css
.karaoke-mode {
  position: relative;
  background: transparent;
}

.karaoke-inner {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
```

---

## 3. UI/UX 设计

### 3.1 布局结构

```
┌─────────────────────────────────────────────┐
│  [每行小节数: - 2 +]       [小节 1 / 24]     │ ← 控制栏
├─────────────────────────────────────────────┤
│                                             │
│  ● 正在播放                                  │
│  ┌───────────────────────────────────────┐  │
│  │ [1] 3  5  6  5  |  [2] 1  2  3  2  |  │  │ ← 第一行（高亮边框）
│  └───────────────────────────────────────┘  │
│                                             │
│  ○ 等待播放                                  │
│  ┌───────────────────────────────────────┐  │
│  │ [3] 5  6  1'  6  |  [4] 5  3  2  1  |  │  │ ← 第二行（半透明）
│  └───────────────────────────────────────┘  │
│                                             │
├─────────────────────────────────────────────┤
│         1=G        4/4                      │ ← 曲谱信息
└─────────────────────────────────────────────┘
```

### 3.2 视觉设计

#### 配色方案
- **背景**: 深色渐变 (`#1a1a2e → #16213e → #0f0f23`)
- **主色调**: 翡翠绿 (`#50C878`) - 用于高亮和强调
- **文本**: 白色/半透明白色
- **边框**: 半透明白色/绿色

#### 动画效果
1. **音符高亮动画** (`highlight-pulse`)
   - 0%: 高亮背景放大至 110%，颜色 80% 不透明度
   - 100%: 缩回至 100%，颜色 40% 不透明度
   - 时长: 0.3s，ease-out

2. **脉冲动画** (`pulse`)
   - 用于"正在播放"指示器
   - 0% & 100%: 完全不透明
   - 50%: 50% 不透明
   - 时长: 1.5s，无限循环

3. **行切换动画**
   - 淡出 + 向上平移 10px
   - 时长: 150ms

### 3.3 响应式设计

- **桌面端** (≥768px)
  - 控制栏显示完整标签
  - 音符字号 28px
  - 充足的内边距

- **移动端** (<768px)
  - 隐藏控制栏标签，仅显示图标
  - 音符字号 24px
  - 紧凑的内边距

---

## 4. 数据流向

### 4.1 播放同步流程

```
┌──────────────┐
│  abcjs MIDI  │ 播放音频
│   Synth      │
└──────┬───────┘
       │ onEvent
       ▼
┌──────────────┐
│ TimingCallbacks│ 获取当前播放元素
└──────┬───────┘
       │ activeNoteIds
       ▼
┌──────────────┐
│  Workbench   │ 传递激活音符 IDs
│    (Props)   │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Karaoke     │ 1. 高亮激活音符
│  Renderer    │ 2. 查找所在小节
└──────┬───────┘ 3. 计算目标行
       │         4. 触发切换动画
       ▼
    [视图更新]
```

### 4.2 切换逻辑伪代码

```javascript
watch(activeNoteIds, (newIds) => {
  // 1. 遍历所有小节
  for (measure of allMeasures) {
    // 2. 检查小节是否包含激活音符
    if (measure.notes.includes(newIds)) {
      // 3. 计算目标行索引
      targetLine = floor(measureIndex / measuresPerLine)
      
      // 4. 如果不在当前行，触发切换
      if (targetLine !== currentLine) {
        isTransitioning = true
        setTimeout(() => {
          currentLine = targetLine
          isTransitioning = false
        }, 150)
      }
      break
    }
  }
})
```

---

## 5. 技术亮点

### 5.1 音符宽度动态计算
- 根据时值信息（延音线数量）动态分配宽度
- 实现更自然的视觉间距

```javascript
const getNoteDisplayWidth = (note) => {
  let width = noteWidth
  if (note.dashes > 0) {
    width += note.dashes * noteWidth
  }
  return width
}
```

### 5.2 自动布局算法
- 每行自动均分可用宽度
- 响应式调整小节渲染宽度

```javascript
const measureRenderWidth = computed(() => {
  const availableWidth = containerWidth.value - 60
  return Math.floor(availableWidth / measuresPerLine.value)
})
```

### 5.3 性能优化
- 使用 `computed` 缓存计算结果
- ResizeObserver 实现高效的容器监听
- 最小化 DOM 操作，仅渲染两行

---

## 6. 使用方式

### 6.1 用户操作流程

1. **进入练功房**
   - 从曲谱库选择一首曲谱
   - 点击"练功房"按钮

2. **切换到卡拉OK模式**
   - 点击顶部工具栏的"🎤 卡拉OK"按钮
   - 系统自动加载并解析 ABC 乐谱

3. **调整显示参数**
   - 使用 `+` / `-` 按钮调整每行小节数
   - 观察实时预览效果

4. **开始播放**
   - 点击底部控制台的"▶ 播放"按钮
   - 系统自动高亮当前音符
   - 播放完一行后自动切换到下一行

5. **选择乐器**（可选）
   - 从顶部乐器选择器中选择
   - 支持钢琴、小提琴、长笛

### 6.2 快捷键（继承自 Workbench）

- `Space`: 播放/暂停
- `⏮`: 回到起点
- `🔁`: 循环播放

---

## 7. 与现有功能的集成

### 7.1 复用的组件/逻辑

1. **useAbcRenderer**
   - 复用 ABC 解析逻辑
   - 获取 `visualObj` 数据结构

2. **useAbcPlayer**
   - 复用 MIDI 播放引擎
   - 复用音符高亮同步机制

3. **Workbench 播放控制器**
   - 共享播放/暂停状态
   - 共享循环模式
   - 共享乐器选择

### 7.2 扩展性考虑

- **模块化设计**: KaraokeRenderer 作为独立组件，可复用于其他视图
- **Props 驱动**: 通过 Props 接收数据，易于测试和维护
- **事件解耦**: 通过 `emit('seek-to-note')` 与父组件通信

---

## 8. 已知限制与未来优化

### 8.1 当前限制

1. **不支持跨行连音线**
   - 当前仅显示两行，跨行的连音线/圆滑线不渲染
   - 未来可考虑在行尾/行首添加视觉提示

2. **固定布局模式**
   - 当前仅支持水平排列
   - 未来可考虑垂直滚动模式

3. **简化的节奏符号**
   - 未实现合并减时线（beams）
   - 未实现三连音括号

### 8.2 优化方向

1. **预加载机制**
   - 提前渲染下一行，减少切换延迟

2. **自适应小节数**
   - 根据屏幕宽度和音符密度自动调整

3. **自定义主题**
   - 支持用户自定义配色方案

4. **导出功能**
   - 支持截图或视频录制当前练习

---

## 9. 测试建议

### 9.1 功能测试

- [ ] 验证双行正确显示
- [ ] 验证音符高亮同步准确性
- [ ] 验证行自动切换流畅性
- [ ] 验证小节数调整功能
- [ ] 验证响应式布局（移动端/桌面端）
- [ ] 验证乐器切换功能

### 9.2 边界测试

- [ ] 空乐谱处理
- [ ] 单小节乐谱
- [ ] 超长乐谱（100+ 小节）
- [ ] 复杂节奏（三连音、附点、休止符）
- [ ] 极端屏幕尺寸

### 9.3 性能测试

- [ ] 长乐谱加载时间
- [ ] 切换动画帧率
- [ ] 内存占用情况

---

## 10. 相关文件清单

### 10.1 新增文件
- `src/components/Score/KaraokeRenderer.vue`

### 10.2 修改文件
- `src/views/Workbench.vue`
- `README.md` (移除模板内容)

### 10.3 依赖文件（无修改）
- `src/composables/useAbcRenderer.js`
- `src/composables/useAbcPlayer.js`
- `src/composables/useScoreData.js`
- `src/components/JianpuScore.vue`

---

## 11. 版本信息

- **功能版本**: v1.0
- **创建日期**: 2026-01-14
- **作者**: GitHub Copilot
- **文档版本**: v1.0

---

## 12. 参考资料

- [abcjs 官方文档](https://github.com/paulrosen/abcjs)
- [简谱渲染与播放技术路线](../2026-01-13/简谱渲染与播放技术路线_20260113_0109.md)
- [Vue 3 Composition API](https://vuejs.org/guide/extras/composition-api-faq.html)
- [Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
