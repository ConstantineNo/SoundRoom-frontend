# 代码修改总结（2026-01-19 至 2026-01-22）

## 概述

本次审查涵盖从提交 `d7eb0f350aed369027747bc2728226ab1d7b63a3`（实现番茄简谱兼容性开发）至当前 HEAD 的所有修改，共计 **17 个提交**，主要集中在番茄简谱渲染功能的修复与优化。

---

## 修改文件统计

- **修改文件数**: 4 个
- **新增文件**: 0 个
- **删除文件**: 0 个
- **主要变更**:
  - `src/fanqie/renderer/FanqieScore.vue`: 大量修改（~589 行）
  - `src/fanqie/parser/parser.js`: 多次修改（~53 行）
  - `src/views/FanqieEditor.vue`: 轻量修改（~19 行）
  - `doc/2026-01-19/`: 新增文档和截图

---

## 详细修改内容

### 1. 修复连音线解析、节拍切分和三连音渲染问题 (3d17a72)

**问题描述**: 连音线位置错误、节拍切分不当、三连音显示异常

**修复内容**:
- **连音线解析 (parser.js)**:
  - 将连音线标记 `(` 和 `(y` 改为下一个音符的前缀处理
  - 在 `parseNote` 开头添加前缀扫描逻辑
  - 修复 `6, (3/ 2/` 中连音线错误附加到前一个音符的问题

- **节拍切分 (FanqieScore.vue)**:
  - Beam（减时线连接）逻辑改为按拍切分
  - 八分音符及更短音符跨拍时自动断开连接线
  - 支持 `beamBreakNext` 标记强制断开

- **三连音渲染**:
  - 新增 `tuplets` 数组检测三连音组
  - 渲染三连音弧线和数字标记
  - 添加 `.tuplet-bracket` 和 `.tuplet-number` CSS 样式

**影响文件**:
- `src/fanqie/parser/parser.js`: +42 -6 行
- `src/fanqie/renderer/FanqieScore.vue`: +90 -3 行

---

### 2. 修复歌词丢失、三连音超界、小节线遮挡等问题 (71f0ad5)

**修复内容**:
- **歌词丢失**: 重新添加歌词分配逻辑到音符布局代码中
- **三连音超出小节线**:
  - 新增 `adjustTupletDurations` 函数处理三连音时值压缩
  - 三连音组时值按 2/3 比例压缩（3个八分音符从1.5拍压缩为1拍）
  - 自动检测 `tupletStart` 标记并找到对应的结束位置
- **第九小节位置**: 通过固定每行4小节逻辑已解决
- **小节线被遮挡**:
  - 增加 SVG 宽度从 800px 到 860px
  - 新增 `lineStartPadding = 30px` 左侧边距
  - 防止最左侧小节线被页面边缘遮挡

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +81 -5 行

---

### 3. 重构排版算法：基于拍号的网格化布局 (062a030)

**重构目标**: 解决音符间距不合理、布局混乱的问题

**核心改动**:
- **废弃内容挤压模式，采用固定网格布局**
- **网格布局规则**:
  - 预留首尾各 10% 空间
  - 中间 80% 按拍数均分
  - 音符位置由绝对拍数决定
- **视觉效果**: 拍内紧凑、拍间疏离
- **增时线**: 强制对齐到整数拍网格中心

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +47 -57 行

---

### 4. 修复连音线起始位置与全音符布局问题 (1ffbd5e)

**修复内容**:
- **修正 `calculateNoteDuration`**: 增时线应为加法计算（`duration += count`）
- **优化增时线布局**:
  - 将音符空间按时值均分
  - 音符与增时线均匀分布
  - 解决挤压与留白问题
- **修复连音线起始位置**: 基于新的均匀分布坐标正确计算
- **固定排版规则**: 强制每行4小节，解决循环节（第9小节）排版错位

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +36 -14 行

---

### 5. 重构简谱渲染逻辑：实现固定小节宽度与时值比例排版 (b807dbe)

**重大重构**:

**核心改动**:
- **重构 `layoutLines`**: 小节扁平化后按每行固定数量（4个）重新分行
- **固定小节宽度**: 200px，为移动端自适应打基础
- **新增 `calculateNoteDuration`**: 基于增时线、减时线、附点计算音符逻辑时值
- **基于时值比例排版**: 解决间距不合理问题
- **重构歌词分配逻辑**: 全局扁平化歌词并重新映射到音符
- **适配新坐标系统**: 重新计算连音线(Slur)和减时线(Beam)

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +200 -130 行

---

### 6. 修复解析器无法识别带空格的修饰符问题 (36aa539)

**问题**: 音符与增时线(`-`)或连音线(`(`)之间有空格时导致解析丢失

**修复**:
- 修改 `parseNote` 方法
- 在解析修饰符循环中跳过 `WHITESPACE` Token
- 确保 `durationExtendCount` 和 `slurStarts/Ends` 能正确写入数据结构

**影响文件**:
- `src/fanqie/parser/parser.js`: +5 行

---

### 7. 修复番茄简谱连音线渲染功能 (6857bfe)

**新增功能**: 实现番茄简谱连音线（slur）的贝塞尔曲线渲染

**技术实现**:
- **贝塞尔曲线渲染**: 使用二次贝塞尔曲线
- **嵌套支持**: 多层连音线自动上移避免重叠
- **弧度自适应**: 根据音符距离动态调整弧度（最大 15px）
- **栈结构处理**: 使用 `slurStarts/slurEnds` 处理嵌套连音线
- **层级计算**: 嵌套层级每层上移 8px
- **CSS样式**: 添加 `.slur-line` 样式定义

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +61 -5 行

---

### 8. 修复番茄简谱歌词渲染逻辑 (ab7bea1)

**修复内容**:
- **修复渲染条件**: `line.lyrics` → `line.computedLyrics`
- **中文歌词对齐**: 按字符与音符对齐
- **特殊符号支持**:
  * `@` - 跳过一个音符
  * `~` - 连接两个字对应一个音符
  * 标点符号自动识别不占音符
- **隐藏休止符**: 过滤隐藏休止符不对应歌词
- **位置对齐**: 歌词位置与对应音符中心对齐

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +64 -10 行

---

### 9. 还原简谱音符字体样式配置 (f6b8e24)

**恢复的样式**:
- `.note-text` - 音符文本样式（20px 粗体居中）
- `.underline` - 减时线样式
- `.dash` - 延时线样式
- `.ending-line` 和 `.ending-label` - 反复记号样式
- 移除歌词的 Microsoft YaHei 字体限制
- 修复上次提交导致的音符位置和显示偏差问题

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +30 -1 行

---

### 10. 修复反复记号、低音点间距及排版优化 (79851ce)

**修复内容**:
- **小节线反复记号渲染**:
  - 左反复 (`|:`) - 粗线+细线+右侧圆点 (`||:`)
  - 右反复 (`:|`) - 左侧圆点+细线+粗线 (`:||`)
- **低音点显示**: 缩小与减时线及点之间的间距
- **音符排版策略**: "拍内紧凑(25px)、拍间疏离(45px)"
- **歌词字体**: 指定为 "Microsoft YaHei" 改善中文显示

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +46 -51 行

---

### 11. 优化音符显示与减时线合并逻辑 (267886f)

**优化内容**:
- **拍内减时线合并**: 实现减时线（下划线）的自动合并渲染（beaming）
- **休止符样式**: 统一休止符 (0) 与其他音符的显示样式（加粗）
- **高低音点布局**:
  - 低音点移至减时线下方
  - 增加音符与装饰符号之间的间距
- **歌词显示**: 修复歌词可能缺失的问题

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +52 -27 行

---

### 12. 修复音符坐标计算导致的显示错位问题 (017b6b2)

**核心问题**: 音符超出小节线、小节显示不完整、歌词不对齐

**修复方案**:
- 将音符渲染坐标 (`relativeX`) 与歌词对齐坐标 (`absoluteX`) 分离
- 解决音符超出小节线、小节显示不完整及歌词不对齐的问题

**影响文件**:
- `src/fanqie/renderer/FanqieScore.vue`: +8 -13 行

---

### 13. 优化编辑器布局与歌词显示 (5585d2f)

**优化内容**:
- **编辑器布局**: 调整左右比例为 35%:65%
- **ABC容器**: 修复隐藏的 ABC 容器导致底部出现五线谱的问题
- **歌词渲染**: 过滤空字符
- **解析器警告**: 增加歌词位置错误的警告提示
- **UI改进**: 编辑器 UI 增加警告信息显示

**影响文件**:
- `src/fanqie/parser/parser.js`: +6 行
- `src/fanqie/renderer/FanqieScore.vue`: +15 -5 行
- `src/views/FanqieEditor.vue`: +19 -4 行

---

### 14. 其他提交

- **216a0d3, 5f7bcb5**: Bugfix 修复（未详细记录）
- **412e843**: 测试相关调整

---

## 总体影响分析

### 代码质量改进
- ✅ 修复了大量渲染和布局相关的 bug
- ✅ 实现了更合理的网格化排版算法
- ✅ 优化了连音线、三连音、歌词等复杂元素的渲染
- ✅ 提升了代码的可维护性和扩展性

### 功能增强
- ✅ 实现了完整的连音线渲染功能（包括嵌套）
- ✅ 实现了三连音的时值压缩和弧线显示
- ✅ 优化了歌词对齐和特殊符号处理
- ✅ 实现了反复记号的正确显示

### 性能和体验
- ✅ 固定小节宽度提升了排版稳定性
- ✅ 网格化布局解决了间距不合理问题
- ✅ 编辑器布局更合理（35%:65%）

### 文档
- 新增了大量截图用于对比和记录（`doc/2026-01-19/`）

---

## 技术亮点

1. **网格化排版算法**: 将内容挤压模式改为固定网格布局，拍内紧凑、拍间疏离
2. **三连音时值压缩**: 自动识别并按 2/3 比例压缩三连音组时值
3. **贝塞尔曲线连音线**: 支持多层嵌套，自动上移避免重叠
4. **坐标系统分离**: 音符渲染坐标与歌词对齐坐标分离，解决错位问题
5. **减时线自动合并**: 实现拍内减时线的智能合并渲染

---

## 潜在改进方向

1. **移动端适配**: 固定小节宽度（200px）为移动端自适应打下了基础
2. **更多记谱元素**: 可以继续扩展对更多音乐符号的支持
3. **交互优化**: 增强编辑器的交互体验
4. **性能优化**: 对于大型乐谱可考虑虚拟滚动等优化方案

---

## 提交时间线

```
2026-01-19 (初始) → 实现番茄简谱兼容性开发 (d7eb0f3)
     ↓
2026-01-19 → 优化编辑器布局与歌词显示 (5585d2f)
     ↓
2026-01-19 → 修复音符坐标计算 (017b6b2)
     ↓
2026-01-19 → 优化音符显示与减时线合并 (267886f)
     ↓
2026-01-19 → 修复反复记号、低音点 (79851ce)
     ↓
2026-01-19 → 还原简谱音符字体样式 (f6b8e24)
     ↓
2026-01-19 → 修复番茄简谱歌词渲染 (ab7bea1)
     ↓
2026-01-19 → 实现连音线渲染 (6857bfe)
     ↓
2026-01-19 → 修复解析器空格问题 (36aa539)
     ↓
2026-01-19 → 重构简谱渲染逻辑 (b807dbe)
     ↓
2026-01-19 → 修复连音线起始位置 (1ffbd5e)
     ↓
2026-01-19 → 重构排版算法 (062a030)
     ↓
2026-01-19 → 修复歌词丢失、三连音超界 (71f0ad5)
     ↓
2026-01-22 → 修复连音线解析、节拍切分、三连音 (3d17a72) [最新]
```

---

*生成日期: 2026-01-22*
*审查范围: d7eb0f3..HEAD*
