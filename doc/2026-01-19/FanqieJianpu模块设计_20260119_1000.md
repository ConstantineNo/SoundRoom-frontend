# FanqieJianpu 模块设计文档

## 概述

本模块实现番茄简谱格式的完整支持，作为独立模块开发，不影响现有 ABC/JianpuScore 功能。

## 模块目录结构

```
src/fanqie/
├── types/
│   └── index.ts                 # 类型定义
├── parser/
│   ├── tokenizer.js             # 词法分析器
│   ├── parser.js                # 语法解析器
│   └── index.js                 # 解析器入口
├── renderer/
│   └── FanqieScore.vue          # 渲染组件
├── converter/
│   └── toAbc.js                 # 转ABC（用于播放）
└── index.js                     # 模块入口
```

---

## 番茄简谱格式规范摘要

### 描述头字段

| 字母 | 说明 | 示例 | 必须 |
|------|------|------|------|
| V | 版本号 | `V: 1.0` | 是 |
| B | 标题（可多次） | `B: 排排坐` | 是 |
| Z | 作者（可多次） | `Z: 佚名 词曲` | - |
| D | 调式 | `D: E` 或 `D: E#` | 是 |
| P | 拍号 | `P: 4/4` 或 `P: 4/4 (2/4)` | 是 |
| J | 节拍 | `J: 120` 或 `J: 欢快的` | - |

### 内容行类型

| 标记 | 说明 |
|------|------|
| `Q:` | 曲谱行 |
| `C:` | 歌词行（依附于上一曲谱行） |
| `#` | 注释行 |

### 音符表示

| 符号 | 说明 |
|------|------|
| `1-7` | 普通音符 |
| `0` | 休止符 |
| `8` | 隐藏休止符（占空间但不显示） |
| `9` | 节奏音符 X |

### 音符修饰符（后缀）

| 符号 | 说明 | 可叠加 |
|------|------|--------|
| `'` | 高八度 | ✓ |
| `,` | 低八度 | ✓ |
| `-` | 增时线 | ✓ |
| `/` | 减时线 | ✓ |
| `.` | 附点 | ✓（双附点`..`） |
| `#` | 升号 | - |
| `$` | 降号 | - |
| `=` | 还原号 | - |

### 节拍切分控制

| 符号 | 说明 |
|------|------|
| `~` | 前后音符串接在一个节拍中 |
| `^` | 前后音符强制切开为两个节拍 |

### 连音线与圆滑线

| 符号 | 说明 |
|------|------|
| `(...)` | 连音线（支持嵌套、跨小节、跨行） |
| `(y...)` | 多连音 |

### 倚音

| 符号 | 说明 |
|------|------|
| `[...]` | 前倚音（默认8分音符） |
| `[h...]` | 后倚音 |

### 小节线

| 符号 | 说明 |
|------|------|
| `\|` | 普通小节线 |
| `\|/` | 隐藏小节线（不占空间） |
| `\|*` | 隐藏小节线（占空间） |
| `\|\|` | 双细线 |
| `\|:` | 左反复 |
| `:\|` | 右反复 |
| `:\|\|:` | 双反复 |
| `\|]` | 终止线 |

### 跳房子

| 符号 | 说明 |
|------|------|
| `[` | 跳房子起点（在小节线处） |
| `]` | 跳房子终点 |
| `[/` | 长段落跳房子（右侧不封闭） |
| `[+...` | 跳房子上移（+越多越高） |

### 力度与表情

| 符号 | 说明 |
|------|------|
| `&mp`, `&mf`, `&f`, `&p` | 力度术语 |
| `<` | 渐强起点 |
| `>` | 渐弱起点 |
| `<+...`, `>+...` | 渐强/渐弱上移调整 |
| `!` | 渐强/渐弱终点 |

### 括号与装饰

| 符号 | 说明 |
|------|------|
| `&zkh` | 左括号（伴奏部分） |
| `&ykh` | 右括号 |
| `&xxx` | 装饰记号（拼音首字母编码） |

### 注释

| 符号 | 说明 |
|------|------|
| `"文字"` | 音符上方注释 |
| `"p:3/4"` | 小节线临时拍号 |

---

## 装饰记号编码表

| 编码 | 符号名称 | 说明 |
|------|----------|------|
| `&bo` | 波音 | 上波音 |
| `&xbo` | 下波音 | 下波音 |
| `&hx` | 回旋 | 回旋音 |
| `&cy` | 颤音 | tr |
| `&dyy` | 倒延音 | 倒延音记号 |
| `&yy` | 延音 | 延音记号 (Fermata) |
| `&dg` | 顿弓 | 顿音 |
| `&bg` | 保持弓 | 保持音 |
| `&zkh` | 左括号 | ( |
| `&ykh` | 右括号 | ) |

---

## 反复记号语法

| 符号 | 语法 | 说明 |
|------|------|------|
| 左反复 | `\|:` | 反复开始 |
| 右反复 | `:\|` | 反复结束 |
| 双反复 | `:\|\|:` | 既是结束又是开始 |
| 终止线 | `\|]` | 曲终 |
| D.C. | `&DC` | 从头反复 |
| D.S. | `&DS` | 从记号处反复 |
| Fine | `&Fine` | 结束记号 |
| Coda | `&Coda` | 尾声记号 |
| Segno | `&Segno` | 反复记号 |

---

## 歌词对齐策略

采用与 ABC 格式类似的对齐方法：

1. **按音符数量对齐**：歌词字符按顺序对应曲谱行的音符
2. **延音处理**：增时线 `-` 对应的音符延续上一个歌词
3. **休止符处理**：休止符 `0` 不消耗歌词
4. **连字符**：使用 `-` 连接多音节词
5. **空格分隔**：歌词中的空格用于分隔不同音符的歌词

---

## 开发计划

1. ✅ 创建设计文档和目录结构
2. 实现类型定义 `types/index.ts`
3. 实现词法分析器 `parser/tokenizer.js`
4. 实现语法解析器 `parser/parser.js`
5. 实现渲染组件 `renderer/FanqieScore.vue`
6. 实现 ABC 转换器 `converter/toAbc.js`
7. 创建编辑器视图 `views/FanqieEditor.vue`
