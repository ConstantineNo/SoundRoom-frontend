# 番茄简谱模块开发文档

## 概述

新增独立的 FanqieJianpu 模块，支持番茄简谱格式的解析、渲染和播放。在不影响现有 ABC/JianpuScore 模块的前提下进行开发。

## 模块目录结构

```
src/fanqie/
├── types/
│   └── index.ts                 # 类型定义
├── parser/
│   ├── tokenizer.js             # 词法分析器
│   ├── parser.js                # 语法解析器
│   └── index.js                 # 解析器入口
├── renderer/
│   └── FanqieScore.vue          # 渲染组件（独立于JianpuScore）
├── converter/
│   └── toAbc.js                 # 转ABC（用于播放）
└── index.js                     # 模块入口
```

---

## 番茄简谱格式规范摘要

### 描述头字段

| 字母 | 说明 | 示例 | 必须 |
|------|------|------|------|
| V | 版本号 | `V: 1.0` | 是 |
| B | 标题 | `B: 排排坐` | 是 |
| Z | 作者 | `Z: 佚名 词曲` | - |
| D | 调式 | `D: E` | 是 |
| P | 拍号 | `P: 4/4` | 是 |
| J | 节拍 | `J: 6` 或 `J: 欢快的` | - |

### 内容行类型

- `Q:` 曲谱行
- `C:` 歌词行（依附于上一曲谱行）
- `#` 注释行

### 音符表示

| 符号 | 说明 |
|------|------|
| `1-7` | 普通音符 |
| `0` | 休止符 |
| `8` | 隐藏休止符（占空间不显示） |
| `9` | 节奏音符 X |

### 音符修饰符

| 符号 | 说明 | 可重复 |
|------|------|--------|
| `'` | 高八度 | ✓ |
| `,` | 低八度 | ✓ |
| `-` | 增时线 | ✓ |
| `/` | 减时线 | ✓ |
| `.` | 附点 | ✓ |
| `#` | 升号 | - |
| `$` | 降号 | - |
| `=` | 还原号 | - |

### 节拍切分控制

| 符号 | 作用 |
|------|------|
| `~` | 前后音符串接在一个节拍中 |
| `^` | 前后音符强制切开为两个节拍 |

### 连音与倚音

| 符号 | 说明 |
|------|------|
| `()` | 连音线（支持嵌套、跨小节、跨行） |
| `(y...)` | 多连音 |
| `[...]` | 前倚音 |
| `[h...]` | 后倚音 |

### 小节线

| 符号 | 说明 |
|------|------|
| `\|` | 普通小节线 |
| `\|/` | 隐藏小节线（不占空间） |
| `\|*` | 隐藏小节线（占空间） |
| `\|\|` | 双细线 |
| `\|:` | 左反复 |
| `:\|` | 右反复 |
| `:\|\|:` | 双反复 |
| `\|]` | 终止线 |

### 跳房子

| 符号 | 说明 |
|------|------|
| `[` | 跳房子起点（在小节线处） |
| `]` | 跳房子终点 |
| `[/` | 长段落跳房子（右侧不封闭） |
| `[+...` | 跳房子上移调整 |

### 力度与表情

| 符号 | 说明 |
|------|------|
| `&mp`, `&mf`, `&f`, `&p` | 力度术语 |
| `<` | 渐强起点 |
| `>` | 渐弱起点 |
| `<+...`, `>+...` | 渐强/渐弱上移调整 |
| `!` | 渐强/渐弱终点 |

### 装饰记号编码表

| 编码 | 符号名称 |
|------|----------|
| `&zkh` | 左括号 |
| `&ykh` | 右括号 |
| `&bo` | 波音 |
| `&shbo` | 上波音 |
| `&xbo` | 下波音 |
| `&hyx` | 滑音线 |
| `&dyx` | 顿音 |
| `&byx` | 保持音 |
| `&qyx` | 强音 |
| `&zy` | 重音 |
| `&yc` | 延长记号 |
| `&hx` | 呼吸记号 |

### 注释

| 符号 | 说明 |
|------|------|
| `"文字"` | 音符上方注释 |
| `"p:x/x"` | 小节线备注中的临时拍号 |

---

## 开发计划

### 阶段一：核心解析器

1. 类型定义 `src/fanqie/types/index.ts`
2. 词法分析器 `src/fanqie/parser/tokenizer.js`
3. 语法解析器 `src/fanqie/parser/parser.js`

### 阶段二：渲染组件

4. 渲染组件 `src/fanqie/renderer/FanqieScore.vue`
5. 布局算法（支持自定义节拍切分）

### 阶段三：播放集成

6. ABC转换器 `src/fanqie/converter/toAbc.js`
7. 编辑器视图 `src/views/FanqieEditor.vue`

---

## 歌词对齐策略

参考 ABC 格式的实现方法：
- 歌词按空格分割为音节
- 音节与音符一一对应
- 使用 `-` 连接多音节词
- 使用 `_` 表示延长音节

---

## 相关文件

- 规范文档: `doc/2026-01-18/支持番茄简谱-formatted.md`
- 示例图片: `doc/2026-01-18/*.png`
