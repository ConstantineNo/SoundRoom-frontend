# 简谱渲染与播放技术路线总结

本文档旨在总结当前项目中简谱（Numbered Musical Notation）渲染与播放的核心技术架构、实现逻辑及前后端交互规范。

---

## 1. 核心技术栈

| 领域       | 技术选型                                                                 |
| ---------- | ------------------------------------------------------------------------ |
| 基础格式   | [ABC Notation](https://abcnotation.com/) (曲谱数据源标准)                |
| 核心库     | [abcjs](https://github.com/paulrosen/abcjs) (ABC 解析、音频合成与播放)   |
| 前端框架   | Vue 3 (Composition API)                                                  |
| 音频技术   | Web Audio API + SoundFonts (FluidR3_GM)                                  |
| HTTP 客户端| Axios                                                                    |
| 后端框架   | FastAPI (Python)                                                         |

---

## 2. 数据流向与生命周期

### 2.1 数据获取阶段 (前后端交互)

```
┌──────────────┐      GET /api/scores/:id       ┌──────────────┐
│              │ ──────────────────────────────>│              │
│   Frontend   │                                │   Backend    │
│   (Vue 3)    │ <──────────────────────────────│  (FastAPI)   │
│              │       { ..., abc_source }      │              │
└──────────────┘                                └──────────────┘
```

1. 前端通过 `useScoreData` composable 封装的 `fetchScore(id)` 方法调用后端 API。
2. 后端返回的曲谱对象包含 `abc_source` 字段（ABC 格式字符串）。
3. 若需更新 ABC 源码，前端调用 `PUT /api/scores/{score_id}/abc` 提交新内容，后端解析后返回 `structured_data`。

### 2.2 解析阶段

1. 用户输入或从后端加载 ABC 格式代码。
2. `useAbcRenderer` 调用 `abcjs.renderAbc('*', abcString)` 进行"无头"渲染。
3. 获取到的 `visualObj` 包含整首歌的节拍、音高、时长及视觉分组信息。

### 2.3 渲染阶段 (自定义简谱引擎)

1. 项目未直接使用 `abcjs` 的五线谱渲染（除非在编辑器模式），而是由 `JianpuScore.vue` 自主负责 SVG 渲染。
2. **逻辑转换**: `src/utils/jianpu.js` 根据当前调性（Key Signature）和"首调唱名法"（Movable Do）逻辑，将音高转换为简谱数字（1-7）。
3. **布局计算**: 遍历 `visualObj` 的行和音符，计算每个简谱符号在 SVG 中的坐标位置（包括减时线、连音线、圆滑线等装饰符号）。

### 2.4 播放阶段 (音频合成)

1. `useAbcPlayer` 初始化 `abcjs.synth.SynthController`。
2. 引擎加载位于 `public/soundfonts/` 的 SoundFonts 资源（如 `acoustic_grand_piano`、`flute`、`violin`）。
3. 音频合成器根据 `visualObj` 生成实时音频流并在 Web Audio 上下文中播放。

---

## 3. 关键挑战：同步与高亮

由于简谱是自定义渲染的，而播放引擎属于 `abcjs`，两者之间的联动通过 **"扁平化 ID 映射策略"** 实现：

1. **唯一 ID 分配**: 在 `useAbcRenderer` 中，通过 `flattenNotes` 将复杂的嵌套乐谱结构转化为一维音符数组，并为每个音符分配一个全局唯一的 `note_id`。
2. **映射表维护**:
    - `elemToIdMap`: 将 `abcjs` 内部生成的 SVG 元素引用映射到 `note_id`。
    - `noteIdToTimingMap`: 记录每个音符的开始时间与时长，用于点击跳转。
3. **播放反馈**:
    - `abcjs.synth` 的 `cursorControl` 回调在播放每个事件时触发。
    - `useAbcPlayer` 通过 `onEvent` 捕获当前正在播放的 `abcjs` 元素。
    - 查找映射表，获得 `activeNoteIds` 并通过 Vue 的响应式系统传递给 `JianpuScore` 组件。
4. **视觉响应**: `JianpuScore.vue` 为对应的音符 `<g>` 标签应用 `.highlight` 类，实现精准的音画同步。

---

## 4. 前后端交互规范

### 4.1 曲谱相关 API

| 操作             | 方法   | 端点                          | 说明                                       |
| ---------------- | ------ | ----------------------------- | ------------------------------------------ |
| 获取曲谱列表     | GET    | `/api/scores/`                | 返回所有曲谱的摘要列表                     |
| 获取曲谱详情     | GET    | `/api/scores/{score_id}`      | 返回单个曲谱详情，含 `abc_source` 字段     |
| 创建曲谱         | POST   | `/api/scores/`                | `multipart/form-data`，含图片和音频        |
| 更新 ABC 源码    | PUT    | `/api/scores/{score_id}/abc`  | 提交 `abc_content`，后端解析并返回结构化数据 |

### 4.2 数据结构示例

**曲谱对象 (Score)**
```json
{
  "id": 1,
  "title": "茉莉花",
  "song_key": "G",
  "flute_key": "C",
  "fingering": "3",
  "tags": ["民歌"],
  "image_path": "uploads/img_xxx.jpg",
  "audio_path": "uploads/audio_xxx.mp3",
  "abc_source": "X:1\nT:茉莉花\nK:G\n...",
  "structured_data": { ... }
}
```

### 4.3 认证机制

- 部分 API（如播放列表操作）需要在请求头携带 JWT Token：
  ```
  Authorization: Bearer <access_token>
  ```
- Token 通过 `POST /api/auth/login` 获取。

### 4.4 错误处理约定

| HTTP 状态码 | 含义                     | 典型场景                       |
| ----------- | ------------------------ | ------------------------------ |
| 200         | 成功                     | 正常响应                       |
| 400         | 请求错误                 | ABC 解析失败、参数校验不通过   |
| 401         | 未授权                   | Token 缺失或过期               |
| 404         | 资源不存在               | 曲谱 ID 不存在                 |
| 500         | 服务器内部错误           | 后端异常                       |

---

## 5. 相关文件索引

| 模块                     | 文件路径                                          |
| ------------------------ | ------------------------------------------------- |
| 核心播放控制器           | `src/composables/useAbcPlayer.js`                 |
| 渲染逻辑封装             | `src/composables/useAbcRenderer.js`               |
| 曲谱数据获取             | `src/composables/useScoreData.js`                 |
| 简谱 SVG 渲染组件        | `src/components/JianpuScore.vue`                  |
| 简谱渲染器包装组件       | `src/components/Score/JianpuRenderer.vue`         |
| 简谱转换工具函数         | `src/utils/jianpu.js`                             |
| 音频资源目录             | `public/soundfonts/`                              |
| API 接口文档             | `doc/2025-12-09/API接口文档_20251209_1817.md`     |

---

## 6. 设计优势

- **跨平台兼容**: 基于 Web 标准（Web Audio API + SVG），无需特定插件。
- **扩展性**: 底层采用 ABC 格式，未来可轻松支持简谱/五线谱的一键切换渲染，且音频逻辑共用。
- **自定义渲染控制**: 自研简谱渲染器可精细控制连音线、装饰音等在中国传统音乐中常见的符号表现。
- **前后端分离**: 前端专注于渲染与播放体验，后端负责数据持久化与 ABC 解析，职责清晰。

---

## 7. 技术架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Vue 3)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────┐    ┌─────────────────┐    ┌───────────────┐  │
│  │ useScoreData  │───>│ useAbcRenderer  │───>│ JianpuScore   │  │
│  │ (数据获取)     │    │ (ABC解析+映射)   │    │ (SVG渲染)     │  │
│  └───────────────┘    └─────────────────┘    └───────────────┘  │
│          │                    │                      ▲          │
│          ▼                    ▼                      │          │
│  ┌───────────────┐    ┌─────────────────┐           │          │
│  │   Axios       │    │  useAbcPlayer   │───────────┘          │
│  │ (HTTP请求)    │    │ (音频播放+高亮)  │  activeNoteIds       │
│  └───────────────┘    └─────────────────┘                       │
│          │                    │                                 │
└──────────┼────────────────────┼─────────────────────────────────┘
           │                    │
           ▼                    ▼
┌──────────────────┐    ┌─────────────────┐
│  Backend API     │    │  Web Audio API  │
│  (FastAPI)       │    │  + SoundFonts   │
└──────────────────┘    └─────────────────┘
```

---

> **文档版本**: v1.0  
> **最后更新**: 2026-01-13
